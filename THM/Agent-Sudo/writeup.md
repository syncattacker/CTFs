# Agent Sudo (Write-up)

## Introduction
 - **Machine Name** : `Agent Sudo` [Solve here](https://tryhackme.com/room/agentsudoctf)
 - **Platform** : `TryHackMe`
 - **Difficulty** : `Easy`
 - **Goal** : Gain access and escalate privileges to gain root user and flag.


## Scanning 

### NMap Scan 

```
nmap -sCV -A -nvv -p- -T5 --min-rate=10000 -o nmap.log <MACHINE-IP>
```
> Refer [NMap Log](./nmap.log)

#### Open Ports

- 21 - FTP `vsFTPD 3.0.3`  
- 22 - SSH `OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)`
- 80 - HTTP `Apache httpd 2.4.29 ((Ubuntu))`

## Enumeration

> The NMap Scan shows the above ports as open upon looking FTP does not seems vulnerable to anonymous login. SSH also not vulnerable to any known vulnerabilities, the HTTP renders a page that says `Dear agents, Use your own codename as user-agent to access the site.From, Agent R`, from this a conclusion can be made that the code name is a single alphabet that `R` for agent R and similar for other agents. But upon using R as the user-agent, it shows `What are you doing! Are you one of the 25 employees? If not, I going to report this incident.` This indicates that the code names can be the english alphabets A-Z anyone is the User-Agent with the access. Now either you can use burpsuite, but I have developed a small script that will use a .txt that is generated by using crunch and match against the response, [user-agent-attack.py](./user-agent-attack.py) and [user-agent.txt](./user-agent-fuzz.txt) and if it gets a distinguished response other than the one that initially comes it will display it on the terminal. One the correct agent code is sent it will give you message that says `tell Agent J to change his weak password and this message has a name that is chris (a possible username for FTP or SSH)`.

## Gaining Access

> I started with brute forcing the ftp via Hydra with rockyou.txt via the following command ```hydra -l chris -P /usr/share/wordlists/rockyou.txt ftp://<MACHINE-IP> -V``` after a few minutes of waiting it successfully finds the password for user chris for FTP protocol. After logging in to FTP we have 3 files those are `To_agentJ.txt` `cute-alien.jpg` `cutie.png`, upon looking at the content of `To_agentJ.txt` it indicates that steganography is used to hide the password.

## Steganography & Analysis

> Now on investigating the images by ```strings cutie.png``` and ```strings cute-alien.jpg``` the cutie.png has a text file embedded into it with the name `To_agentR.txt`, further I used `binwalk -e cutie.png --run-as=root` and it extracts the hidden files into a zip but the zip is password protected, now we can use john to crack the password ```zip2john <zip-file> > hash.txt``` ```john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt --format=zip```, after the password is cracked you get a the text file that contains the a base string that can be decoded by the following command ```echo "<base-string>" | base64 -d``` that is the password for the steghide for uncovering the hidden message in the cute-alien.jpg ```steghide extract -sf cute-alien.jpg -p <password>``` now the message.txt extracted from here contains the ssh passowrd for the user james and upon login you get the user flag and a image which is an extra little reverse image search question.

## Privilege Escalation

> Later in order to escalate privileges I checked ```sudo -V``` to check the version to know whether it is vulnerable to any known vulnerabilities and it is the vulnerability is `CVE-2019-14287` that allows to escalate privileges to root even though the user is restricted to execute bash as sudo, by the following payload ```sudo -u#-1 /bin/bash``` [Refer Here](https://www.exploit-db.com/exploits/47502), Yayy! Y0u ar3 r00t. Happy Hacking!

 
## Target Summary
 - **Target IP** : `10.x.x.x`
 - **Hostname** : `agent-sudo`
 - **Known Services** : `FTP, SSH, HTTP`
 - **Initial Access Vectors** : `FTP Brute Force`
 - **Privilege Escalation Vector** : `sudo misconfiguration (CVE-2019-14287)`

## Toolkit
 - `nmap`
 - `hydra`
 - `binwalk / steghide`
 - `john`
 - `burpsuite`
 - `custom coding`

## Additional

> Although this is the complete write-up with the exact steps to get into the machine, but I have also tried gobuster for directory enumeration as this was one of the basic checklists and the machine was not known to me. You can look at the gobuster logs [GoBuster Scan](./gobuster.log) or run the following command ```└─# gobuster dir -u "http://<MACHINE-IP>" -w /usr/share/wordlists/rockyou.txt -t 64 --no-errors -v -o gobuster.log```.

## References 
- [Exploit-DB](https://www.exploit-db.com/exploits/47502)

> HAPPY HACKING! @[syncattacker](https://github.com/syncattacker)

